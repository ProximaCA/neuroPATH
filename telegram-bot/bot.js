// ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
require('dotenv').config();

const { Bot, InlineKeyboard } = require('grammy');

// ะะฐะผะตะฝะธัะต ะฝะฐ ะฒะฐั ัะพะบะตะฝ ะฑะพัะฐ ะพั @BotFather
const BOT_TOKEN = process.env.BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';

// URL ะฒะฐัะตะณะพ ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธั (ะทะฐะผะตะฝะธัะต ะฝะฐ ะฒะฐั ัะตะฐะปัะฝัะน URL)
const WEB_APP_URL = process.env.WEB_APP_URL || 'http://localhost:3000';

const bot = new Bot(BOT_TOKEN);

// ะัะปะฐะดะพัะฝัะน ะฒัะฒะพะด
console.log('๐ค ะะฐะฟััะบ Telegram ะฑะพัะฐ...');
console.log('๐ ะขะพะบะตะฝ ะทะฐะณััะถะตะฝ:', BOT_TOKEN ? 'ะะฐ' : 'ะะตั');
console.log('๐ URL ะฟัะธะปะพะถะตะฝะธั:', WEB_APP_URL);

// ะะพะผะฐะฝะดะฐ /start
bot.command('start', async (ctx) => {
  const startPayload = ctx.match; // ะะพะปััะฐะตะผ ะฟะฐัะฐะผะตัั ะฟะพัะปะต /start
  let referralMessage = '';
  
  // ะัะพะฒะตััะตะผ ะตััั ะปะธ ัะตัะตัะฐะปัะฝัะน ะบะพะด
  if (startPayload && startPayload.startsWith('ref_')) {
    const referrerId = startPayload.replace('ref_', '');
    referralMessage = `\n๐ ะั ะฟัะธัะปะธ ะฟะพ ะฟัะธะณะปะฐัะตะฝะธั! ะะฐ ัะตะณะธัััะฐัะธั ะฒั ะธ ะฒะฐั ะดััะณ ะฟะพะปััะธัะต ะฟะพ +100 ะกะะะขะ!`;
    
    // ะัะฟัะฐะฒะปัะตะผ ะดะฐะฝะฝัะต ะฒ ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะต ะดะปั ะพะฑัะฐะฑะพัะบะธ ัะตัะตัะฐะปะฐ
    console.log(`๐ฅ ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ${ctx.from.id} ะฟัะธัะตะป ะฟะพ ัะตัะตัะฐะปัะฝะพะน ัััะปะบะต ะพั ${referrerId}`);
    
    // ะกะพััะฐะฝัะตะผ ัะตัะตัะฐะปัะฝัั ะธะฝัะพัะผะฐัะธั ะฒ URL ะดะปั ะพะฑัะฐะฑะพัะบะธ ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะตะผ
    const webAppUrl = `${WEB_APP_URL}?referrer=${referrerId}&new_user=${ctx.from.id}`;
    const keyboard = new InlineKeyboard()
      .webApp('๐ง ะัะบัััั ะะปัะธะผะธั ะะฐะทัะผะฐ', webAppUrl);

    await ctx.reply(
      `๐ ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ "ะะปัะธะผะธั ะะฐะทัะผะฐ"!${referralMessage}

ะญัะพ ะฟัะธะปะพะถะตะฝะธะต ะฟะพะผะพะถะตั ะฒะฐะผ:
โข ะัะพัะฐะฑะพัะฐัั ัะผะพัะธะธ ัะตัะตะท 4 ััะธัะธะธ
โข ะัะฒะพะธัั ะผะตะดะธัะฐัะธะฒะฝัะต ะฟัะฐะบัะธะบะธ
โข ะกะพะฑัะฐัั ะบะพะปะปะตะบัะธั ะฐััะตัะฐะบัะพะฒ
โข ะััะปะตะถะธะฒะฐัั ัะฒะพะน ะฟัะพะณัะตัั

ะะฐะถะผะธัะต ะบะฝะพะฟะบั ะฝะธะถะต, ััะพะฑั ะฝะฐัะฐัั ะฟััะตัะตััะฒะธะต:`,
      { reply_markup: keyboard }
    );
    return;
  }

  const keyboard = new InlineKeyboard()
    .webApp('๐ง ะัะบัััั ะะปัะธะผะธั ะะฐะทัะผะฐ', WEB_APP_URL);

  await ctx.reply(
    `๐ ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ "ะะปัะธะผะธั ะะฐะทัะผะฐ"!

ะญัะพ ะฟัะธะปะพะถะตะฝะธะต ะฟะพะผะพะถะตั ะฒะฐะผ:
โข ะัะพัะฐะฑะพัะฐัั ัะผะพัะธะธ ัะตัะตะท 4 ััะธัะธะธ
โข ะัะฒะพะธัั ะผะตะดะธัะฐัะธะฒะฝัะต ะฟัะฐะบัะธะบะธ
โข ะกะพะฑัะฐัั ะบะพะปะปะตะบัะธั ะฐััะตัะฐะบัะพะฒ
โข ะััะปะตะถะธะฒะฐัั ัะฒะพะน ะฟัะพะณัะตัั

ะะพะผะฐะฝะดั - /help
ะะฐะถะผะธัะต ะบะฝะพะฟะบั ะฝะธะถะต, ััะพะฑั ะฝะฐัะฐัั ะฟััะตัะตััะฒะธะต:`,
    { reply_markup: keyboard }
  );
});

// ะะพะผะฐะฝะดะฐ /help
bot.command('help', async (ctx) => {
  await ctx.reply(
    `๐ฎ ะะพะผะฐะฝะดั ะฑะพัะฐ:

/start - ะัะบัััั ะฟัะธะปะพะถะตะฝะธะต
/profile - ะะพัะผะพััะตัั ะฟัะพัะธะปั
/progress - ะะพะบะฐะทะฐัั ะฟัะพะณัะตัั
/help - ะญัะฐ ัะฟัะฐะฒะบะฐ

ะัะฝะพะฒะฝะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ะฟัะพะธััะพะดะธั ัะตัะตะท ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะต.`
  );
});

// ะะพะผะฐะฝะดะฐ /profile
bot.command('profile', async (ctx) => {
  const keyboard = new InlineKeyboard()
    .webApp('๐ค ะัะบัััั ะฟัะพัะธะปั', `${WEB_APP_URL}/profile`);

  await ctx.reply(
    '๐ค ะะฐั ะฟัะพัะธะปั ะฒ ะฟัะธะปะพะถะตะฝะธะธ:',
    { reply_markup: keyboard }
  );
});

// ะะพะผะฐะฝะดะฐ /progress
bot.command('progress', async (ctx) => {
  const keyboard = new InlineKeyboard()
    .webApp('๐ ะะพัะผะพััะตัั ะฟัะพะณัะตัั', `${WEB_APP_URL}/profile`);

  await ctx.reply(
    '๐ ะััะปะตะถะธะฒะฐะนัะต ัะฒะพะน ะฟัะพะณัะตัั ะฒ ะฟัะธะปะพะถะตะฝะธะธ:',
    { reply_markup: keyboard }
  );
});

// ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ั ะดะฐะฝะฝัะผะธ ะพั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธั
bot.on('message:web_app_data', async (ctx) => {
  const data = JSON.parse(ctx.message.web_app_data.data);
  
  switch (data.type) {
    case 'mission_completed':
      await ctx.reply(
        `๐ ะะพะทะดัะฐะฒะปัะตะผ! ะั ะทะฐะฒะตััะธะปะธ ะผะธััะธั "${data.missionName}"!
        
๐ ะะพะปััะตะฝ ะฐััะตัะฐะบั: ${data.artifact}
โญ ะะฐัะฐะฑะพัะฐะฝะพ ะกะะะขะ: ${data.lightEarned}
๐ ะะพะฒัะน ััะพะฒะตะฝั: ${data.level}`
      );
      break;
      
    case 'element_unlocked':
      await ctx.reply(
        `๐ ะะพะฒะฐั ััะธัะธั ัะฐะทะฑะปะพะบะธัะพะฒะฐะฝะฐ: ${data.elementName}!
        
ะขะตะฟะตัั ะดะพัััะฟะฝั ะฝะพะฒัะต ะผะตะดะธัะฐัะธะธ ะธ ะฐััะตัะฐะบัั.`
      );
      break;
      
    case 'friend_light_sent':
      await ctx.reply(
        `๐ซ ะั ะพัะฟัะฐะฒะธะปะธ ${data.amount} ะกะะะขะ ะฟะพะปัะทะพะฒะฐัะตะปั ${data.friendName}!
        
ะะพะฑััะต ะดะตะปะฐ ะฒะพะทะฒัะฐัะฐัััั ัะดะฐัะตะน. โจ`
      );
      break;
      
    default:
      await ctx.reply('ะะฐะฝะฝัะต ะฟะพะปััะตะฝั! ๐');
  }
});

// ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
bot.catch((err) => {
  console.error('ะัะธะฑะบะฐ ะฑะพัะฐ:', err);
});

// ะะฐะฟััะบ ะฑะพัะฐ
bot.start();

console.log('โ ะะพั ะทะฐะฟััะตะฝ ะธ ะณะพัะพะฒ ะบ ัะฐะฑะพัะต!');

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('๐ ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ...');
  bot.stop();
  process.exit(0);
});

process.once('SIGTERM', () => {
  console.log('๐ ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ...');
  bot.stop();
  process.exit(0);
}); 